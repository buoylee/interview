# 综合

## CAP 理论

CAP 定理，又被叫作布鲁尔定理。对于设计分布式系统来说(不仅仅是分布式事务)的架构师来说，CAP 就是你的入门理论。

- C (一致性)：在分布式系统中的**所有数据备份，在同一时刻是否同样的值。**（等同于所有节点访问同一份最新的数据副本）
- A (可用性)：在集群中**一部分节点故障**后，**集群整体是否还能响应客户端的读写请求**。（对数据更新具备高可用性）
- P (分区容错性)：以实际效果而言，**分区相当于对通信的时限要求**。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在 C 和 A 之间做出选择。





# sage

简介: 如果某个步骤失败，则根据相反顺序一次调用补偿操作。



可以看到，和 TCC 相比，Saga 没有“预留 try”动作 ，它的 Ti 就是直接提交到库。



Saga的执行顺序有两种：

- 子事务序列 T1, T2, …, Tn得以完成 (最佳情况)。
- 或者序列 T1, T2, …, Tj, Cj, …, C2, C1, 0 < j < n, 得以完成。



## 如何解决没有 Prepare阶段可能带来的问题?

由于 Saga 模型中没有 Prepare 阶段，因此事务间不能保证隔离性，当多个 Saga 事务操作同一资源时，就会产生更新丢失、脏数据读取等问题，这时需要在业务层控制并发。例如：

- 在应用层面加锁。
- 应用层面预先冻结资源。



**就是还未最终提交, 其他线程就能使用 提交后的数据.**



还是拿 100 元买一瓶水的例子来说。

- 这里定义：
  - T1=扣100元 T2=给用户加一瓶水 T3=减库存一瓶水
  - C1=加100元 C2=给用户减一瓶水 C3=给库存加一瓶水
- 我们一次进行 T1，T2，T3。如果发生问题，就执行发生问题的 C 操作的反向。上面说到的隔离性的问题会出现在，如果执行到 T3 这个时候需要执行回滚，但是这个用户已经把水喝了(**另外一个事务**)，回滚的时候就会发现，无法给用户减一瓶水了。这就是事务之间没有隔离性的问题。



