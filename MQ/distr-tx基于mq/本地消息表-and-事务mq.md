[toc]

## 本地消息表

**关键点:**

- **业务操作**和**本地消息表插入**需要放在**同一个事务**
- 本地消息表需要一个记录**当前消息是否完成消费的state字段**
- 因为事务的执行异常, **有可能发任何情况**(网络/程序/宕机), 我们可能需要**多次发起并消费这条消息**, 直到明确的成功/失败, 所以我们需要一个**定时任务来重试**.
- 只有当事务消息消费的每一个环节都完成, 并最终将消息表的**消费state设置为已完成, 才会停止重试**(或者人工介入).
- 因为**不可避免的重试**机制存在, 需要**业务保证事务的幂等**.



## rocketMQ 事务消息

**关键点:**

- 业务段仍然需要本地消息表?), 用于 rocketMQ在未收到**业务对rocketMQ commit/rollback response时, 回查**.
- 业务向rocketMQ发起half msg, 其实就是未完成状态的消息. 不会让消费端消费.
- 一旦half msg 写入成功, 执行本地业务
- 根据本地业务是否成功, 来选择给MQ发送Commit/Rollback.
- 当出现 rocketMQ 未收到 Commit/Rollback的响应时, rocketMQ会向业务的消息生产端, 发起一次当前消息的状态查询, 最终, 把状态重新推送给 MQ.





## 参考

[RabbitMQ，RocketMQ，Kafka 事务性，消息丢失，消息顺序性和消息重复发送的处理策略 ](https://www.cnblogs.com/ricklz/p/15747565.html)

