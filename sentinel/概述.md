[toc]

## 遇到问题

1. 访问量达到一定程度, 扛不住
2. 内部某个服务响应时间过长, 连锁反应, 导致整个服务不了用.

可能是线程耗尽



## 解决思路

设置超时

资源隔离

限流

熔断, 有半熔断机制, 就是定时尝试请求, 如果成功, 则关闭断路器, 否则, 保持打开.

扩容

消息队列削峰

服务降级, 返回默认值; 还有一种定义, 统称为降级

## 与Hystrix区别

<img src="Screenshot 2024-11-08 at 16.19.18.png" alt="Screenshot 2024-11-08 at 16.19.18" style="zoom:50%;" />

可以基于响应时间/失败率策略开启熔断

流量整形

系统负载保护

控制台更完善

## sentinel 内部概念

### 资源

可以是接口/一段代码

### 规则

流控, 熔断降级, 系统保护 规则, 都可以动态实时调整.

## 使用方式

api, 注解, 控制台,
@RequestMapping, @sentinelResource 也会被识别拦截到, 生成对应的资源在控制台

因为api, 注解, 都有侵入式, 且不够灵活, 

BlockExceptionHandler 统一限流处理接口

## 流控

有QPS 和 并发线程数 纬度的控制.

### 流控模式

#### 直接

直接限制当前资源

#### 关联

当关联的资源受限, 当前资源也受限, 可以是没有上下调用关系的.
例: /save 受限, 因为写锁, 导致/read 不可读, 所以直接流控比较好. 

#### 链路

是有上架下游关系的
出口的接口限流了, 直接对入口的接口限流更直接有效.(限上游), 如果有多个, 只会对指定的这个入口限制

## 降级

### 熔断策略

### <img src="Screenshot 2024-11-08 at 20.49.57.png" alt="Screenshot 2024-11-08 at 20.49.57" style="zoom:50%;" />

底层通过断路器实现, 
基于时间, 基于异常 断路器

#### 慢调用比例

#### 异常比例

#### 异常数

### 参数流控

### 授权规则

黑白名单

<img src="Screenshot 2024-11-09 at 00.04.16.png" alt="Screenshot 2024-11-09 at 00.04.16" style="zoom:50%;" />

流控应用是调用方, 对他黑名单, 就是 order不可以调 /test3

